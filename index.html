<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการข้อมูลลูกค้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fee2e2;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4b5563;
        }
        .input-group input[type="text"], .input-group input[type="tel"], .input-group input[type="date"], .input-group input[type="number"], .input-group input[type="url"] {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #2563eb;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        .btn-danger {
            background-color: #ef4444;
            color: #fff;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-success {
            background-color: #10b981;
            color: #fff;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .customer-card {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        .customer-card h3 {
            font-weight: 600;
            color: #1f2937;
        }
        .customer-card p {
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .customer-card.service-due {
            background-color: #fef2f2;
            border-color: #f87171;
            animation: pulse 1.5s infinite;
        }
        .image-preview {
            width: 100%;
            height: 120px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #6b7280;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .warranty-expired-text {
            color: #ef4444; /* red-500 */
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container shadow-lg">
        <!-- Logo Header -->
        <div class="text-center mb-6">
            <img id="appLogo" src="" alt="App Logo" class="mx-auto" style="max-width: 250px;">
        </div>
        
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">จัดการข้อมูลลูกค้า</h1>

        <!-- Logo Upload Section -->
        <div class="mb-6">
            <label for="logoUpload" class="block text-sm font-medium text-gray-700 mb-2">อัปโหลดโลโก้</label>
            <input type="file" id="logoUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-center mb-6 space-x-4">
            <button id="showAllCustomersBtn" class="btn btn-primary">ดูข้อมูลลูกค้าทั้งหมด</button>
            <button id="showDueCustomersBtn" class="btn btn-danger">ดูรายการเซอร์วิสที่ต้องเตือน</button>
        </div>
        
        <!-- Current Date Display and Test Date Input -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 text-sm text-gray-500 gap-2">
            <span id="currentDateDisplay" class="font-medium text-gray-700"></span>
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <label for="testDateInput" class="whitespace-nowrap">วันที่จำลอง:</label>
                <input type="date" id="testDateInput" class="p-2 border rounded-md text-gray-700 w-full">
            </div>
        </div>

        <!-- Custom Alert/Message Box -->
        <div id="messageBox" class="bg-red-500 text-white text-center py-3 px-4 rounded-lg mb-4 hidden"></div>

        <!-- Form for adding a new customer -->
        <form id="customerForm" class="mb-8">
            <input type="hidden" id="customerId">
            <div class="input-group">
                <label for="name">ชื่อลูกค้า</label>
                <input type="text" id="name" placeholder="กรุณากรอกชื่อลูกค้า" required>
            </div>
            <div class="input-group">
                <label for="address">ที่อยู่</label>
                <input type="text" id="address" placeholder="กรุณากรอกที่อยู่">
            </div>
            <div class="input-group">
                <label for="phone">เบอร์โทรศัพท์</label>
                <input type="tel" id="phone" placeholder="กรุณากรอกเบอร์โทรศัพท์">
            </div>
            <div class="input-group">
                <label for="googleMapsLink">ลิงก์ Google Maps</label>
                <input type="url" id="googleMapsLink" placeholder="วางลิงก์ Google Maps ที่นี่">
            </div>
            <!-- New input fields for installed equipment -->
            <div class="input-group">
                <label for="inverterModel">รุ่นอินเวอร์เตอร์</label>
                <input type="text" id="inverterModel" placeholder="กรอกรุ่นอินเวอร์เตอร์">
            </div>
            <div class="input-group">
                <label for="inverterSN">เลข SN อินเวอร์เตอร์</label>
                <input type="text" id="inverterSN" placeholder="กรอกเลข SN อินเวอร์เตอร์">
            </div>
            <div class="input-group">
                <label for="panelModel">รุ่นแผง</label>
                <input type="text" id="panelModel" placeholder="กรอกรุ่นแผง">
            </div>
            <div class="input-group">
                <label for="panelCount">จำนวนแผงที่ติดตั้ง</label>
                <input type="number" id="panelCount" min="0" placeholder="กรอกจำนวนแผง">
            </div>
            <div class="input-group">
                <label for="startDate">วันที่ติดตั้งระบบ</label>
                <div class="flex items-center gap-2">
                    <input type="date" id="startDate" class="flex-grow">
                    <button type="button" id="setTodayBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-colors">ตั้งค่าวันนี้</button>
                </div>
            </div>
            <div class="input-group">
                <label for="serviceYears">ระยะเวลาการเซอร์วิส (ปี)</label>
                <input type="number" id="serviceYears" value="1" min="1" max="10">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="image1" class="mb-2 block">รูปภาพ 1</label>
                    <div id="image1Preview" class="image-preview mb-2">
                        <span>เลือกรูปภาพ</span>
                        <input type="file" id="image1Input" class="hidden" accept="image/*">
                    </div>
                </div>
                <div>
                    <label for="image2" class="mb-2 block">รูปภาพ 2</label>
                    <div id="image2Preview" class="image-preview mb-2">
                        <span>เลือกรูปภาพ</span>
                        <input type="file" id="image2Input" class="hidden" accept="image/*">
                    </div>
                </div>
            </div>
            <div class="input-group mt-4">
                <label for="image3" class="mb-2 block">รูปภาพ 3 (แนวนอน)</label>
                <div id="image3Preview" class="w-full h-48 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center p-2 text-sm text-gray-500 overflow-hidden cursor-pointer relative">
                    <span>เลือกรูปภาพ</span>
                    <input type="file" id="image3Input" class="hidden" accept="image/*">
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-full mt-4">เพิ่มลูกค้า</button>
        </form>

        <!-- Customer list section -->
        <div id="customerList">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">รายการลูกค้า</h2>
            <!-- Customer cards will be inserted here by JavaScript -->
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <p id="confirmMessage" class="text-lg font-medium text-gray-800 mb-6">คุณแน่ใจหรือไม่?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmYes" class="btn btn-danger">ใช่</button>
                <button id="confirmNo" class="btn btn-primary">ไม่</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, onSnapshot, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and initialization
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof __initial_auth_token !== 'undefined') {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            userId = auth.currentUser.uid;
            console.log("Authenticated with user ID:", userId);
            
            const customerForm = document.getElementById('customerForm');
            const customerList = document.getElementById('customerList');
            const customerIdInput = document.getElementById('customerId');
            const image1Input = document.getElementById('image1Input');
            const image2Input = document.getElementById('image2Input');
            const image3Input = document.getElementById('image3Input');
            const image1Preview = document.getElementById('image1Preview');
            const image2Preview = document.getElementById('image2Preview');
            const image3Preview = document.getElementById('image3Preview');
            const messageBox = document.getElementById('messageBox');
            const confirmModal = document.getElementById('confirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');
            const startDateInput = document.getElementById('startDate');
            const serviceYearsInput = document.getElementById('serviceYears');
            const setTodayBtn = document.getElementById('setTodayBtn');
            const currentDateDisplay = document.getElementById('currentDateDisplay');
            const testDateInput = document.getElementById('testDateInput');
            const submitBtn = customerForm.querySelector('button[type="submit"]');
            const logoUploadInput = document.getElementById('logoUpload');
            const appLogo = document.getElementById('appLogo');
            const showAllCustomersBtn = document.getElementById('showAllCustomersBtn');
            const showDueCustomersBtn = document.getElementById('showDueCustomersBtn');
            const formSection = document.getElementById('customerForm');
            const googleMapsLinkInput = document.getElementById('googleMapsLink');
            const inverterModelInput = document.getElementById('inverterModel');
            const inverterSNInput = document.getElementById('inverterSN');
            const panelModelInput = document.getElementById('panelModel');
            const panelCountInput = document.getElementById('panelCount');

            let currentImages = { image1: '', image2: '', image3: '' };
            let customers = [];
            let confirmCallback = null;

            // Load logo from Firestore on startup
            const logoDocRef = doc(db, `artifacts/${appId}/public/settings/logo`);
            const logoUnsubscribe = onSnapshot(logoDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().logo) {
                    appLogo.src = docSnap.data().logo;
                } else {
                    appLogo.src = 'https://placehold.co/250x100/A0A0A0/FFFFFF?text=UDsolarmax+Logo';
                }
            });

            let currentDate = new Date();
            
            const displayCurrentDate = () => {
                const dateToDisplay = testDateInput.value ? new Date(testDateInput.value) : currentDate;
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = dateToDisplay.toLocaleDateString('th-TH', options);
                currentDateDisplay.textContent = `วันที่ปัจจุบัน: ${formattedDate}`;
            };
            
            const setToday = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                startDateInput.value = `${year}-${month}-${day}`;
            };

            const showMessage = (message) => {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            };

            const showConfirm = (message, callback) => {
                confirmMessage.textContent = message;
                confirmModal.classList.add('active');
                confirmCallback = callback;
            };

            confirmYes.addEventListener('click', () => {
                confirmModal.classList.remove('active');
                if (confirmCallback) {
                    confirmCallback(true);
                }
            });

            confirmNo.addEventListener('click', () => {
                confirmModal.classList.remove('active');
                if (confirmCallback) {
                    confirmCallback(false);
                }
            });
            
            const handleImageUpload = (input, previewElement, imageKey) => {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = "w-full h-full object-cover";
                        previewElement.innerHTML = '';
                        previewElement.appendChild(img);
                        currentImages[imageKey] = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            image1Preview.addEventListener('click', () => image1Input.click());
            image2Preview.addEventListener('click', () => image2Input.click());
            image3Preview.addEventListener('click', () => image3Input.click());
            
            image1Input.addEventListener('change', () => handleImageUpload(image1Input, image1Preview, 'image1'));
            image2Input.addEventListener('change', () => handleImageUpload(image2Input, image2Preview, 'image2'));
            image3Input.addEventListener('change', () => handleImageUpload(image3Input, image3Preview, 'image3'));

            const resetImagePreviews = (customer = {}) => {
                const imagePreviews = [image1Preview, image2Preview, image3Preview];
                const imageKeys = ['image1', 'image2', 'image3'];

                imagePreviews.forEach((preview, index) => {
                    const key = imageKeys[index];
                    preview.innerHTML = customer[key] ? `<img src="${customer[key]}" class="w-full h-full object-cover" alt="รูปภาพลูกค้า ${index + 1}">` : `<span>เลือกรูปภาพ</span>`;
                });
                
                currentImages = {
                    image1: customer.image1 || '',
                    image2: customer.image2 || '',
                    image3: customer.image3 || ''
                };
            };
            
            const findServiceStatus = (startDate, serviceYears, dateToCheck) => {
                if (!startDate) return { status: 'ไม่ระบุ', nextDate: 'ไม่ระบุ' };
                const start = new Date(startDate);
                const warrantyEnd = new Date(start);
                warrantyEnd.setFullYear(start.getFullYear() + serviceYears);
                
                if (dateToCheck.getTime() > warrantyEnd.getTime()) {
                    return { status: 'expired', nextDate: 'ระบบหมดการรับประกันแล้ว' };
                }

                for (let i = 1; i <= serviceYears; i++) {
                    const serviceDate = new Date(start);
                    serviceDate.setFullYear(start.getFullYear() + i);
                    
                    const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
                    if (serviceDate.getTime() >= dateToCheck.getTime() - thirtyDaysInMs) {
                        return { status: 'due', nextDate: serviceDate.toISOString().split('T')[0] };
                    }
                }
                return { status: 'ok', nextDate: 'ยังไม่ถึงกำหนด' };
            };

            const renderCustomers = (filterDue = false) => {
                const dateForCheck = testDateInput.value ? new Date(testDateInput.value) : currentDate;
                const filteredCustomers = filterDue 
                    ? customers.filter(c => findServiceStatus(c.startDate, c.serviceYears, dateForCheck).status === 'due')
                    : customers;

                customerList.innerHTML = `<h2 class="text-2xl font-semibold mb-4 text-gray-700">รายการลูกค้า</h2>`;
                if (filteredCustomers.length === 0) {
                    customerList.innerHTML += '<p class="text-center text-gray-500">ยังไม่มีข้อมูลลูกค้า</p>';
                    return;
                }
                
                filteredCustomers.forEach(customer => {
                    const { status, nextDate } = findServiceStatus(customer.startDate, customer.serviceYears, dateForCheck);
                    const dueStatus = status === 'due' ? 'service-due' : '';

                    const customerCard = document.createElement('div');
                    customerCard.className = `customer-card ${dueStatus}`;
                    
                    let nextServiceText = `<strong>นัดเซอร์วิสครั้งต่อไป:</strong> ${nextDate}`;
                    let warrantyMessage = '';

                    if (status === 'expired') {
                        nextServiceText = `<span class="warranty-expired-text"><strong>ระบบหมดการรับประกันแล้ว</strong></span>`;
                        warrantyMessage = `<p class="warranty-expired-text mt-2 text-center"><strong>ระบบหมดการรับประกันแล้ว</strong></p>`;
                    } else if (status === 'due') {
                        nextServiceText = `<p class="font-bold text-red-500"><strong>นัดเซอร์วิสครั้งต่อไป:</strong> ${nextDate}</p>`;
                    }

                    customerCard.innerHTML = `
                        <h3 class="text-xl font-semibold">${customer.name}</h3>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                           <div>
                                <p><strong>ที่อยู่:</strong> ${customer.address || 'ไม่ระบุ'}</p>
                                <p><strong>เบอร์โทรศัพท์:</strong> ${customer.phone || 'ไม่ระบุ'}</p>
                                ${customer.googleMapsLink ? `<p><a href="${customer.googleMapsLink}" target="_blank" class="text-blue-500 hover:underline">ดูแผนที่</a></p>` : ''}
                                <p><strong>วันที่ติดตั้ง:</strong> ${customer.startDate || 'ไม่ระบุ'}</p>
                                <p><strong>รุ่นอินเวอร์เตอร์:</strong> ${customer.inverterModel || 'ไม่ระบุ'}</p>
                                <p><strong>เลข SN อินเวอร์เตอร์:</strong> ${customer.inverterSN || 'ไม่ระบุ'}</p>
                                <p><strong>รุ่นแผง:</strong> ${customer.panelModel || 'ไม่ระบุ'}</p>
                                <p><strong>จำนวนแผง:</strong> ${customer.panelCount || 'ไม่ระบุ'}</p>
                                ${customer.lastServiceDate ? `<p><strong>บริการครั้งล่าสุด:</strong> ${customer.lastServiceDate}</p>` : ''}
                                <p><strong>ระยะเวลาการเซอร์วิส:</strong> ${customer.serviceYears || 'ไม่ระบุ'} ปี</p>
                                ${nextServiceText}
                            </div>
                            <div class="h-48">
                                ${customer.image3 ? `<img src="${customer.image3}" class="rounded-lg w-full h-full object-cover" alt="รูปภาพลูกค้า 3">` : '<div class="w-full h-full bg-gray-200 rounded-lg flex items-center justify-center p-2 text-sm text-gray-500">ไม่มีรูปภาพ 3</div>'}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-4">
                            <div class="h-32">
                                ${customer.image1 ? `<img src="${customer.image1}" class="rounded-lg w-full h-full object-cover" alt="รูปภาพลูกค้า 1">` : '<div class="w-full h-full bg-gray-200 rounded-lg flex items-center justify-center p-2 text-sm text-gray-500">ไม่มีรูปภาพ 1</div>'}
                            </div>
                            <div class="h-32">
                                ${customer.image2 ? `<img src="${customer.image2}" class="rounded-lg w-full h-full object-cover" alt="รูปภาพลูกค้า 2">` : '<div class="w-full h-full bg-gray-200 rounded-lg flex items-center justify-center p-2 text-sm text-gray-500">ไม่มีรูปภาพ 2</div>'}
                            </div>
                        </div>
                        
                        ${warrantyMessage}
                        <div class="mt-4 flex space-x-2">
                            <button class="btn btn-primary edit-btn" data-id="${customer.id}">แก้ไข</button>
                            <button class="btn btn-danger delete-btn" data-id="${customer.id}">ลบ</button>
                            ${status === 'due' ? `<button class="btn btn-success complete-service-btn" data-id="${customer.id}">บริการแล้ว</button>` : ''}
                        </div>
                    `;
                    customerList.appendChild(customerCard);
                });
            };

            const listenForCustomers = () => {
                const customerCollection = collection(db, `artifacts/${appId}/public/data/customers`);
                onSnapshot(customerCollection, (snapshot) => {
                    customers = [];
                    snapshot.forEach(doc => {
                        customers.push({ id: doc.id, ...doc.data() });
                    });
                    renderCustomers();
                });
            };

            customerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = customerIdInput.value;
                const name = document.getElementById('name').value;
                const address = document.getElementById('address').value;
                const phone = document.getElementById('phone').value;
                const googleMapsLink = googleMapsLinkInput.value;
                const inverterModel = inverterModelInput.value;
                const inverterSN = inverterSNInput.value;
                const panelModel = panelModelInput.value;
                const panelCount = panelCountInput.value;
                const startDate = startDateInput.value;
                const serviceYears = parseInt(serviceYearsInput.value, 10);

                if (!name) {
                    showMessage('กรุณากรอกชื่อลูกค้า');
                    return;
                }
                
                const customerData = {
                    name,
                    address,
                    phone,
                    googleMapsLink,
                    inverterModel,
                    inverterSN,
                    panelModel,
                    panelCount,
                    startDate,
                    serviceYears,
                    image1: currentImages.image1,
                    image2: currentImages.image2,
                    image3: currentImages.image3,
                };

                try {
                    if (id) {
                        const customerDocRef = doc(db, `artifacts/${appId}/public/data/customers`, id);
                        await updateDoc(customerDocRef, customerData);
                        showMessage('อัปเดตข้อมูลลูกค้าเรียบร้อยแล้ว');
                    } else {
                        const customerCollection = collection(db, `artifacts/${appId}/public/data/customers`);
                        await addDoc(customerCollection, customerData);
                        showMessage('เพิ่มลูกค้าใหม่เรียบร้อยแล้ว');
                    }
                    customerForm.reset();
                    resetImagePreviews();
                    customerIdInput.value = '';
                    submitBtn.textContent = 'เพิ่มลูกค้า';
                } catch (error) {
                    console.error("Error writing document: ", error);
                    showMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                }
            });

            customerList.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.classList.contains('edit-btn')) {
                    const idToEdit = target.getAttribute('data-id');
                    const customerToEdit = customers.find(customer => customer.id === idToEdit);
                    if (customerToEdit) {
                        customerIdInput.value = customerToEdit.id;
                        document.getElementById('name').value = customerToEdit.name;
                        document.getElementById('address').value = customerToEdit.address;
                        document.getElementById('phone').value = customerToEdit.phone;
                        googleMapsLinkInput.value = customerToEdit.googleMapsLink;
                        inverterModelInput.value = customerToEdit.inverterModel;
                        inverterSNInput.value = customerToEdit.inverterSN;
                        panelModelInput.value = customerToEdit.panelModel;
                        panelCountInput.value = customerToEdit.panelCount;
                        startDateInput.value = customerToEdit.startDate;
                        serviceYearsInput.value = customerToEdit.serviceYears;
                        
                        resetImagePreviews(customerToEdit);
                        
                        submitBtn.textContent = 'บันทึกการแก้ไข';
                    }
                } else if (target.classList.contains('delete-btn')) {
                    const idToDelete = target.getAttribute('data-id');
                    showConfirm('คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลลูกค้ารายนี้?', async (result) => {
                        if (result) {
                            try {
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/customers`, idToDelete));
                                showMessage('ลบข้อมูลลูกค้าเรียบร้อยแล้ว');
                            } catch (error) {
                                console.error("Error removing document: ", error);
                                showMessage('เกิดข้อผิดพลาดในการลบข้อมูล');
                            }
                        }
                    });
                } else if (target.classList.contains('complete-service-btn')) {
                    const idToComplete = target.getAttribute('data-id');
                    showConfirm('คุณแน่ใจหรือไม่ว่าต้องการบันทึกว่าการเซอร์วิสนี้เสร็จสิ้นแล้ว?', async (result) => {
                        if (result) {
                            try {
                                const dateForCheck = testDateInput.value ? new Date(testDateInput.value) : currentDate;
                                const todayISO = dateForCheck.toISOString().split('T')[0];
                                const customerDocRef = doc(db, `artifacts/${appId}/public/data/customers`, idToComplete);
                                await updateDoc(customerDocRef, { lastServiceDate: todayISO });
                                showMessage('บันทึกการเซอร์วิสเรียบร้อยแล้ว');
                            } catch (error) {
                                console.error("Error updating document: ", error);
                                showMessage('เกิดข้อผิดพลาดในการบันทึกการเซอร์วิส');
                            }
                        }
                    });
                }
            });
            
            setTodayBtn.addEventListener('click', () => {
                setToday();
            });

            testDateInput.addEventListener('change', () => {
                displayCurrentDate();
                renderCustomers(document.getElementById('showDueCustomersBtn').classList.contains('active'));
            });

            logoUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const logoData = { logo: e.target.result };
                        try {
                            await setDoc(doc(db, `artifacts/${appId}/public/settings/logo`), logoData);
                            showMessage('บันทึกโลโก้เรียบร้อยแล้ว');
                        } catch (error) {
                            console.error("Error uploading logo: ", error);
                            showMessage('เกิดข้อผิดพลาดในการอัปโหลดโลโก้');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            showAllCustomersBtn.addEventListener('click', () => {
                formSection.style.display = 'block';
                renderCustomers(false);
            });

            showDueCustomersBtn.addEventListener('click', () => {
                formSection.style.display = 'none';
                renderCustomers(true);
            });

            displayCurrentDate();
            listenForCustomers();
        });
    </script>
</body>
</html>
