<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบการอ้างสิทธิ์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .container {
            max-width: 800px;
        }

        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
        }

        input,
        select,
        textarea {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            transition: all 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: #ffffff;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #d1d5db;
        }

        .btn-red {
            background-color: #ef4444;
            color: #ffffff;
        }

        .btn-red:hover:not(:disabled) {
            background-color: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .message-box {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }

        .message-box.show {
            opacity: 1;
        }

        .message-box-error {
            background-color: #fecaca;
            color: #b91c1c;
        }

        .message-box-success {
            background-color: #d1fae5;
            color: #065f46;
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto">
        <div id="login-section" class="card mb-8">
            <h1 class="text-3xl font-bold mb-6 text-center">เข้าสู่ระบบ</h1>
            <div class="mb-4">
                <label for="email" class="block text-gray-700 font-bold mb-2">อีเมล:</label>
                <input type="email" id="email" placeholder="ชื่อผู้ใช้@example.com" class="p-3">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 font-bold mb-2">รหัสผ่าน:</label>
                <input type="password" id="password" placeholder="รหัสผ่าน" class="p-3">
            </div>
            <div class="flex justify-center">
                <button id="loginBtn" class="btn btn-primary w-full">เข้าสู่ระบบ</button>
            </div>
        </div>

        <div id="app-section" class="hidden">
            <div class="card mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-3xl font-bold">ระบบจัดการเอกสาร</h1>
                    <div class="flex items-center space-x-4">
                        <span id="user-info" class="text-sm font-medium text-gray-600"></span>
                        <button id="logoutBtn" class="btn btn-secondary text-sm">ออกจากระบบ</button>
                    </div>
                </div>
                <div class="mb-6">
                    <p class="text-gray-600">
                        <span id="user-role-info"></span>
                    </p>
                </div>

                <div class="mt-8">
                    <h2 class="text-2xl font-bold mb-4">เอกสารสาธารณะ</h2>
                    <ul id="public-documents" class="space-y-4"></ul>
                </div>

                <div class="mt-8">
                    <h2 class="text-2xl font-bold mb-4">เอกสารส่วนตัว</h2>
                    <ul id="private-documents" class="space-y-4"></ul>
                </div>

                <div class="mt-8">
                    <h2 class="text-2xl font-bold mb-4">สร้างเอกสารใหม่</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="new-title" class="block font-bold">ชื่อเอกสาร:</label>
                            <input type="text" id="new-title" class="mt-1" placeholder="ใส่ชื่อเอกสารที่นี่">
                        </div>
                        <div>
                            <label for="new-content" class="block font-bold">เนื้อหา:</label>
                            <textarea id="new-content" class="mt-1" rows="5"
                                placeholder="ใส่เนื้อหาของเอกสารที่นี่"></textarea>
                        </div>
                        <div>
                            <label for="new-is-public" class="inline-flex items-center">
                                <input type="checkbox" id="new-is-public" class="rounded text-blue-500">
                                <span class="ml-2">เอกสารสาธารณะ</span>
                            </label>
                        </div>
                        <button id="add-doc-btn" class="btn btn-primary w-full">เพิ่มเอกสาร</button>
                    </div>
                </div>

                <div id="editing-area" class="mt-8 hidden">
                    <h2 class="text-2xl font-bold mb-4">แก้ไขเอกสาร</h2>
                    <div class="space-y-4">
                        <input type="hidden" id="edit-doc-id">
                        <div>
                            <label for="edit-title" class="block font-bold">ชื่อเอกสาร:</label>
                            <input type="text" id="edit-title" class="mt-1">
                        </div>
                        <div>
                            <label for="edit-content" class="block font-bold">เนื้อหา:</label>
                            <textarea id="edit-content" class="mt-1" rows="5"></textarea>
                        </div>
                        <div class="flex space-x-4">
                            <button id="update-doc-btn" class="btn btn-primary flex-1">บันทึกการแก้ไข</button>
                            <button id="cancel-edit-btn" class="btn btn-secondary flex-1">ยกเลิก</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="message-box" class="message-box hidden"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, getDoc, setDoc, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Initialization
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const __app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            setLogLevel('Debug');

            const loginSection = document.getElementById('login-section');
            const appSection = document.getElementById('app-section');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const userInfo = document.getElementById('user-info');
            const userRoleInfo = document.getElementById('user-role-info');
            const publicDocsList = document.getElementById('public-documents');
            const privateDocsList = document.getElementById('private-documents');
            const newTitleInput = document.getElementById('new-title');
            const newContentInput = document.getElementById('new-content');
            const newIsPublicCheckbox = document.getElementById('new-is-public');
            const addDocBtn = document.getElementById('add-doc-btn');
            const editingArea = document.getElementById('editing-area');
            const editTitleInput = document.getElementById('edit-title');
            const editContentInput = document.getElementById('edit-content');
            const updateDocBtn = document.getElementById('update-doc-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const messageBox = document.getElementById('message-box');

            let currentUser = null;
            let userRole = null;
            let isAuthReady = false;

            const showMessage = (message, type) => {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'message-box-error', 'message-box-success');
                messageBox.classList.add('show');
                if (type === 'success') {
                    messageBox.classList.add('message-box-success');
                } else {
                    messageBox.classList.add('message-box-error');
                }
                setTimeout(() => {
                    messageBox.classList.remove('show');
                    setTimeout(() => messageBox.classList.add('hidden'), 500);
                }, 3000);
            };

            const toggleEditArea = (show) => {
                if (show) {
                    editingArea.classList.remove('hidden');
                    addDocBtn.classList.add('hidden');
                } else {
                    editingArea.classList.add('hidden');
                    addDocBtn.classList.remove('hidden');
                }
            };

            const renderDocumentItem = (doc, isPublic = false) => {
                const docId = doc.id;
                const docData = doc.data();
                const listItem = document.createElement('li');
                listItem.className = 'p-4 border border-gray-200 rounded-lg flex justify-between items-center';
                const isOwner = currentUser && docData.ownerId === currentUser.uid;
                const isAdmin = userRole === 'admin';
                const isEditor = userRole === 'editor';
                const canEdit = isOwner || isAdmin;
                const canDelete = isOwner || isAdmin;

                // Adjust `canEdit` for the specific requirement
                if (isEditor) {
                    // Editor can't edit anything, even their own docs
                    canEdit = false;
                }

                listItem.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-lg">${docData.title}</h3>
                        <p class="text-gray-500 text-sm">
                            <span class="mr-2">ID: ${docId}</span>
                            <span>ผู้สร้าง: ${docData.ownerEmail}</span>
                        </p>
                        <p class="mt-2 text-gray-800">${docData.content}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="btn btn-secondary btn-edit text-sm" data-id="${docId}" ${canEdit ? '' : 'disabled'}>แก้ไข</button>
                        <button class="btn btn-red btn-delete text-sm" data-id="${docId}" ${canDelete ? '' : 'disabled'}>ลบ</button>
                    </div>
                `;

                if (isPublic) {
                    listItem.querySelector('.btn-delete').classList.add('hidden'); // No delete for public docs for now
                    if (isEditor) {
                        listItem.querySelector('.btn-edit').disabled = true;
                    }
                }
                
                return listItem;
            };

            const fetchDocuments = (userId) => {
                if (!isAuthReady) return;

                // Listen for public documents
                const publicDocsQuery = collection(db, `artifacts/${__app_id}/public/data/documents`);
                onSnapshot(publicDocsQuery, (snapshot) => {
                    publicDocsList.innerHTML = '';
                    snapshot.forEach(doc => {
                        const item = renderDocumentItem(doc, true);
                        publicDocsList.appendChild(item);
                    });
                }, (error) => {
                    console.error("Error fetching public documents:", error);
                    showMessage('ไม่สามารถดึงเอกสารสาธารณะได้', 'error');
                });

                // Listen for private documents
                const privateDocsQuery = collection(db, `artifacts/${__app_id}/users/${userId}/documents`);
                onSnapshot(privateDocsQuery, (snapshot) => {
                    privateDocsList.innerHTML = '';
                    snapshot.forEach(doc => {
                        const item = renderDocumentItem(doc, false);
                        privateDocsList.appendChild(item);
                    });
                }, (error) => {
                    console.error("Error fetching private documents:", error);
                    showMessage('ไม่สามารถดึงเอกสารส่วนตัวได้', 'error');
                });
            };

            // Event Listeners
            loginBtn.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage('เข้าสู่ระบบสำเร็จ!', 'success');
                } catch (error) {
                    console.error("Login failed:", error);
                    showMessage(`การเข้าสู่ระบบล้มเหลว: ${error.message}`, 'error');
                }
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessage('ออกจากระบบสำเร็จ!', 'success');
                } catch (error) {
                    console.error("Logout failed:", error);
                    showMessage(`การออกจากระบบล้มเหลว: ${error.message}`, 'error');
                }
            });

            addDocBtn.addEventListener('click', async () => {
                if (!currentUser) return;
                const title = newTitleInput.value;
                const content = newContentInput.value;
                const isPublic = newIsPublicCheckbox.checked;

                if (!title || !content) {
                    showMessage('กรุณาใส่ชื่อเรื่องและเนื้อหา', 'error');
                    return;
                }

                try {
                    let docRef;
                    if (isPublic) {
                        docRef = collection(db, `artifacts/${__app_id}/public/data/documents`);
                    } else {
                        docRef = collection(db, `artifacts/${__app_id}/users/${currentUser.uid}/documents`);
                    }

                    await addDoc(docRef, {
                        title: title,
                        content: content,
                        ownerId: currentUser.uid,
                        ownerEmail: currentUser.email,
                        createdAt: new Date()
                    });
                    newTitleInput.value = '';
                    newContentInput.value = '';
                    newIsPublicCheckbox.checked = false;
                    showMessage('เพิ่มเอกสารสำเร็จ!', 'success');
                } catch (error) {
                    console.error("Error adding document:", error);
                    showMessage(`ไม่สามารถเพิ่มเอกสารได้: ${error.message}`, 'error');
                }
            });

            const handleEditClick = async (event) => {
                const docId = event.target.dataset.id;
                const listItem = event.target.closest('li');
                const isPublic = listItem.parentNode.id === 'public-documents';

                if (isEditor) {
                    showMessage('คุณไม่มีสิทธิ์ในการแก้ไขเอกสาร', 'error');
                    return;
                }
                
                let docRef;
                if (isPublic) {
                    docRef = doc(db, `artifacts/${__app_id}/public/data/documents/${docId}`);
                } else {
                    docRef = doc(db, `artifacts/${__app_id}/users/${currentUser.uid}/documents/${docId}`);
                }
                
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        editTitleInput.value = data.title;
                        editContentInput.value = data.content;
                        document.getElementById('edit-doc-id').value = docId;
                        document.getElementById('update-doc-btn').dataset.isPublic = isPublic;
                        toggleEditArea(true);
                    } else {
                        showMessage('ไม่พบเอกสาร', 'error');
                    }
                } catch (error) {
                    console.error("Error fetching document for edit:", error);
                    showMessage('ไม่สามารถดึงเอกสารเพื่อแก้ไขได้', 'error');
                }
            };

            const handleUpdateClick = async () => {
                const docId = document.getElementById('edit-doc-id').value;
                const newTitle = editTitleInput.value;
                const newContent = editContentInput.value;
                const isPublic = document.getElementById('update-doc-btn').dataset.isPublic === 'true';

                if (userRole === 'editor') {
                    showMessage('คุณไม่มีสิทธิ์ในการแก้ไขเอกสาร', 'error');
                    return;
                }

                if (!newTitle || !newContent) {
                    showMessage('กรุณาใส่ชื่อเรื่องและเนื้อหา', 'error');
                    return;
                }
                
                let docRef;
                if (isPublic) {
                    docRef = doc(db, `artifacts/${__app_id}/public/data/documents/${docId}`);
                } else {
                    docRef = doc(db, `artifacts/${__app_id}/users/${currentUser.uid}/documents/${docId}`);
                }
                
                try {
                    await updateDoc(docRef, {
                        title: newTitle,
                        content: newContent,
                        updatedAt: new Date()
                    });
                    toggleEditArea(false);
                    showMessage('บันทึกการแก้ไขสำเร็จ!', 'success');
                } catch (error) {
                    console.error("Error updating document:", error);
                    showMessage(`ไม่สามารถบันทึกการแก้ไขได้: ${error.message}`, 'error');
                }
            };

            const handleDeleteClick = async (event) => {
                const docId = event.target.dataset.id;
                const listItem = event.target.closest('li');
                const isPublic = listItem.parentNode.id === 'public-documents';

                if (isEditor) {
                    showMessage('คุณไม่มีสิทธิ์ในการลบเอกสาร', 'error');
                    return;
                }
                
                if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบเอกสารนี้?')) {
                    let docRef;
                    if (isPublic) {
                        docRef = doc(db, `artifacts/${__app_id}/public/data/documents/${docId}`);
                    } else {
                        docRef = doc(db, `artifacts/${__app_id}/users/${currentUser.uid}/documents/${docId}`);
                    }
                    
                    try {
                        await deleteDoc(docRef);
                        showMessage('ลบเอกสารสำเร็จ!', 'success');
                    } catch (error) {
                        console.error("Error deleting document:", error);
                        showMessage(`ไม่สามารถลบเอกสารได้: ${error.message}`, 'error');
                    }
                }
            };

            document.addEventListener('click', (event) => {
                if (event.target.classList.contains('btn-edit')) {
                    handleEditClick(event);
                }
                if (event.target.classList.contains('btn-delete')) {
                    handleDeleteClick(event);
                }
            });

            updateDocBtn.addEventListener('click', handleUpdateClick);
            cancelEditBtn.addEventListener('click', () => toggleEditArea(false));

            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user) {
                    const idTokenResult = await user.getIdTokenResult(true);
                    userRole = idTokenResult.claims.role || 'user';
                    userInfo.textContent = `ผู้ใช้: ${user.email}`;
                    userRoleInfo.textContent = `ระดับสิทธิ์: ${userRole}`;
                    loginSection.classList.add('hidden');
                    appSection.classList.remove('hidden');
                    isAuthReady = true;
                    fetchDocuments(user.uid);
                    
                    // Show a message box indicating the role upon login
                    showMessage(`เข้าสู่ระบบในฐานะ ${userRole}`, 'success');

                } else {
                    currentUser = null;
                    userRole = null;
                    loginSection.classList.remove('hidden');
                    appSection.classList.add('hidden');
                    isAuthReady = false;
                    publicDocsList.innerHTML = '';
                    privateDocsList.innerHTML = '';
                    toggleEditArea(false);
                }
            });

            if (__initial_auth_token) {
                signInWithCustomToken(auth, __initial_auth_token).catch(async (error) => {
                    console.error("Initial auth failed:", error);
                    // Fallback to anonymous sign-in
                    await signInAnonymously(auth);
                });
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous auth failed:", error);
                });
            }
        } else {
            document.body.innerHTML = '<div class="flex items-center justify-center min-h-screen text-lg font-bold">ไม่พบการตั้งค่า Firebase กรุณาตรวจสอบการตั้งค่า Firebase ของคุณ</div>';
        }
    </script>
</body>

</html>
